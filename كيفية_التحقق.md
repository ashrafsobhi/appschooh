# كيفية التحقق من المشكلة

## الخطوة 1: فتح Django Shell

افتح Terminal أو Command Prompt في مجلد المشروع واكتب:

```bash
python manage.py shell
```

## الخطوة 2: التحقق من الطالب في قاعدة البيانات

انسخ والصق الكود التالي في Django shell:

```python
from student_affairs.models import Student
from django.db.models import Q

# البحث عن الطالب
student = Student.objects.filter(name__icontains='رحمة').first()

if student:
    print("=" * 50)
    print(f"الاسم: {student.name}")
    print(f"الكود: {student.student_code}")
    print(f"الصف (grade): {repr(student.grade)}")
    print(f"الصف فارغ؟: {student.grade is None or student.grade == ''}")
    print(f"الفصل: {student.classroom}")
    if student.classroom:
        print(f"صف الفصل: {student.classroom.grade}")
    print(f"النوع: {student.gender}")
    print("=" * 50)
    
    # التحقق من الفلترة
    all_students = Student.objects.all()
    
    female_g1 = all_students.filter(
        Q(gender='female') & (
            Q(grade='g1') | 
            Q(classroom__grade='g1') |
            (
                (Q(grade__isnull=True) | Q(grade='')) &
                ~(Q(grade__in=['g2', 'g3']) | Q(classroom__grade__in=['g2', 'g3']))
            )
        )
    ).distinct()
    
    print(f"\nعدد الطلاب في الصف الأول (بنات): {female_g1.count()}")
    
    if student in female_g1:
        print("✓ الطالب موجود في قائمة الصف الأول")
    else:
        print("✗ الطالب غير موجود في قائمة الصف الأول")
        print("\nالتحقق من الشروط:")
        print(f"  grade='g1'? {student.grade == 'g1'}")
        print(f"  classroom__grade='g1'? {student.classroom and student.classroom.grade == 'g1'}")
        print(f"  grade فارغ؟ {student.grade is None or student.grade == ''}")
        print(f"  grade ليس g2 أو g3؟ {student.grade not in ['g2', 'g3']}")
else:
    print("لم يتم العثور على الطالب")
```

## الخطوة 3: التحقق من جميع الطلاب بدون grade

```python
# جميع الطلاب بدون grade محدد
students_no_grade = Student.objects.filter(
    Q(grade__isnull=True) | Q(grade='')
)

print(f"عدد الطلاب بدون grade: {students_no_grade.count()}")

for s in students_no_grade[:5]:
    print(f"  - {s.name} ({s.student_code}): grade={repr(s.grade)}")
```

## الخطوة 4: إذا كان grade ليس فارغاً

إذا وجدت أن `grade` يحتوي على قيمة غير متوقعة (مثل `None` أو `''` أو قيمة أخرى)، يمكنك إصلاحها:

```python
# إصلاح grade للطالب
student = Student.objects.filter(name__icontains='رحمة').first()
if student:
    student.grade = None  # أو '' أو 'g1'
    student.save()
    print("تم تحديث grade")
```

## الخطوة 5: اختبار الفلترة مباشرة

```python
from student_affairs.models import Student
from django.db.models import Q

# اختبار الفلترة التي نستخدمها
all_students = Student.objects.all()

# الصف الأول للبنات
female_g1 = all_students.filter(
    Q(gender='female') & (
        Q(grade='g1') | 
        Q(classroom__grade='g1') |
        (
            (Q(grade__isnull=True) | Q(grade='')) &
            ~(Q(grade__in=['g2', 'g3']) | Q(classroom__grade__in=['g2', 'g3']))
        )
    )
).distinct()

print(f"عدد الطلاب في الصف الأول (بنات): {female_g1.count()}")
for s in female_g1[:10]:
    print(f"  - {s.name}: grade={repr(s.grade)}, classroom={s.classroom}")
```

## ملاحظات مهمة

1. **تأكد من أن `grade` فارغ أو `None`**: إذا كان `grade` يحتوي على مسافات أو قيمة أخرى، لن يعمل الفلتر.
2. **تحقق من `classroom`**: إذا كان الطالب في فصل من الصف الثاني أو الثالث، لن يظهر في الصف الأول.
3. **تحقق من `gender`**: تأكد من أن النوع صحيح (male/female).

